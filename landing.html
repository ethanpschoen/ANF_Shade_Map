<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Website Template</title>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css' rel='stylesheet' />
  <script src="https://unpkg.com/mapbox-gl-shadow-simulator/dist/mapbox-gl-shadow-simulator.umd.min.js"></script>
  <!-- Include toGeoJSON library to convert GPX to GeoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      margin: 20px 0;
      font-size: 36px;
      font-weight: bold;
      text-align: center;
    }
    .subheading {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }
    #map-placeholder {
      width: 90%;
      height: 500px;
      background-color: grey;
      border: 2px solid black;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
    }
    .text-box {
      margin-top: 20px;
      width: 90%;
    }
    textarea {
      width: 100%;
      height: 100px;
      font-size: 16px;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header><u>Angeles National Forest Shade Map</u></header>
  <div id="map-placeholder"></div>
  <div class="subheading">Welcome to the Angeles National Forest Shade Map</div>
  <div class="text-box">
    <p>Insert text + background information here</p>
  </div>

  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoiZXNjaG9lbiIsImEiOiJjbTdiMmNlZjMwOHd5MmpwdTNiaGJ6eGVuIn0.Y9yNK2bpxmADMIHptRQgPw";
    
    const bounds = [
      [-118.508, 34.136], // Southwest coordinates
      [-117.414, 34.516]   // Northeast coordinates
    ];
    
    const map = new mapboxgl.Map({
      container: 'map-placeholder',
      center: [-117.961, 34.326], // Angeles National Forest
      zoom: 1,
      style: 'mapbox://styles/mapbox/streets-v11',
      maxBounds: bounds
    });

    // Custom control classes and functions for time slider and date picker remain unchanged
    class CustomControl {
      constructor(element, position = 'top-right') {
        this.container = document.createElement('div');
        this.container.className = `mapboxgl-ctrl custom-control mapboxgl-ctrl-${position}`;
        this.container.appendChild(element);
      }

      onAdd(map) {
        return this.container;
      }

      onRemove() {
        this.container.parentNode.removeChild(this.container);
      }
    }

    function createTimeSlider(map, shadeMap) {
      var sliderContainer = document.createElement('div');
      sliderContainer.className = 'custom-control-container';

      var label = document.createElement('label');
      label.innerHTML = 'Time of Day:';
      
      var slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '0';
      slider.max = '23';
      slider.step = '1';
      slider.value = '12';

      var timeDisplay = document.createElement('span');
      timeDisplay.innerHTML = '12:00 PM';

      slider.addEventListener('input', function() {
        var hours = parseInt(this.value);
        var ampm = hours >= 12 ? 'PM' : 'AM';
        var displayHours = hours % 12 || 12;
        timeDisplay.innerHTML = displayHours + ':00 ' + ampm;
        
        var date = new Date();
        date.setHours(this.value);
        shadeMap.setDate(date);
      });

      sliderContainer.appendChild(label);
      sliderContainer.appendChild(slider);
      sliderContainer.appendChild(timeDisplay);

      console.log("Time Slider Created");

      return sliderContainer;
    }

    function createDatePicker(map, shadeMap) {
      var datePickerContainer = document.createElement('div');
      datePickerContainer.className = 'custom-control-container';

      var button = document.createElement('button');
      button.innerHTML = 'Select Date';

      var datePicker = document.createElement('input');
      datePicker.type = 'date';
      datePicker.style.display = 'none';

      button.addEventListener('click', function() {
        if (datePicker.style.display === 'none') {
          datePicker.style.display = 'block';
        } else {
          datePicker.style.display = 'none';
        }
      });

      datePicker.addEventListener('input', function() {
        var date = new Date(this.value);
        shadeMap.setDate(date);
      });
      
      datePickerContainer.appendChild(button);
      datePickerContainer.appendChild(datePicker);

      return datePickerContainer;
    }
  
    map.on('load', () => {
      const shadeMap = new ShadeMap({
        date: new Date(),    // display shadows for current date
        color: '#01112f',    // shade color
        opacity: 0.7,        // opacity of shade color
        apiKey: "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImVzY2hvZW5Ab3h5LmVkdSIsImNyZWF0ZWQiOjE3MzgzNzIyNjU3MDIsImlhdCI6MTczODM3MjI2NX0.Q6OYzdDPi2Ky256BaXqFIWUjseVsio9_QboTejYxleI",    // obtain from https://shademap.app/about/
        terrainSource: {
          tileSize: 256,       // DEM tile size
          maxZoom: 15,         // Maximum zoom of DEM tile set
          getSourceUrl: ({ x, y, z }) => {
            return `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`;
          },
          getElevation: ({ r, g, b, a }) => {
            return (r * 256 + g + b / 256) - 32768;
          }
        },
        debug: (msg) => { console.log(new Date().toISOString(), msg); },
      }).addTo(map);
  
      // Advance shade by 1 hour
      shadeMap.setDate(new Date(Date.now() + 1000 * 60 * 60));

      map.scrollZoom.enable({
        around: 'mouse'
      })
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();

      map.addControl(new CustomControl(createTimeSlider(map, shadeMap), 'middle-right'));
      map.addControl(new CustomControl(createDatePicker(map, shadeMap), 'top-right'));

      // Load and display the GPX trail from the Trails folder
      fetch('Trails/Whitney Canyon Falls Trail [CLOSED].gpx')
        .then(response => response.text())
        .then(gpxData => {
          // Parse the GPX data using DOMParser
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(gpxData, 'application/xml');
          // Convert GPX to GeoJSON using toGeoJSON
          const geojson = toGeoJSON.gpx(xmlDoc);

          // Add the GPX trail as a new source
          map.addSource('trail', {
            type: 'geojson',
            data: geojson
          });

          // Add a layer to visualize the trail
          map.addLayer({
            id: 'trail-layer',
            type: 'line',
            source: 'trail',
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#000000', // Customize the color as needed
              'line-width': 2
            }
          });
        })
        .catch(error => console.error("Error loading GPX file:", error));
    });
  </script>
</body>
</html>

